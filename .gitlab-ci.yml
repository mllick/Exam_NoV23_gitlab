image: docker:latest
services:
  - name: docker:dind
    alias: docker

variables:
  DOCKER_IMAGE_PREFIX: sarrlick
  KUBE_NAMESPACE_DEV: dev
  KUBE_NAMESPACE_QA: qa
  KUBE_NAMESPACE_STAGING: staging
  KUBE_NAMESPACE_PROD: prod
  DOCKER_DRIVER: overlay2

stages:
  - Test acceptation
  - Build image
  - Release image
  - Deploy dev
  - Deploy qa
  - Deploy staging
  - Deploy prod

before_script:
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY

.test acceptation:
  stage: Test acceptation
  image: python:latest
  before_script:
    # Show docker daemon info (optional, good for debugging)
    # - sudo apt install python3-pip -y
  script:
    #- pip install -r requirements.txt
    - sudo apt-get install -y python3-pip
    - pip install fastapi
    - pip install pytest
    - pip install httpx
    - cd app/
    - python3 -m pytest

build:
  stage: Build image
  script:
    - docker build -t $DOCKER_IMAGE_PREFIX/gateway ./gateway
    - docker build -t $DOCKER_IMAGE_PREFIX/users ./users
    - docker build -t $DOCKER_IMAGE_PREFIX/orders ./orders
  artifacts:
    paths:
      - $DOCKER_IMAGE_PREFIX/gateway.tar
      - $DOCKER_IMAGE_PREFIX/users.tar
      - $DOCKER_IMAGE_PREFIX/orders.tar

release image:
  stage: Release image
  script:
    - ls -l $DOCKER_IMAGE_PREFIX || true
    - ls -l $DOCKER_IMAGE_PREFIX/gateway.tar || true
    - docker load < $DOCKER_IMAGE_PREFIX/gateway.tar || true
    - docker tag DOCKER_IMAGE_PREFIX/gateway "${IMAGE_NAME}:${CI_COMMIT_REF_NAME}"
    - docker tag DOCKER_IMAGE_PREFIX/gateway "${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}"
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - docker push "${IMAGE_NAME}:${CI_COMMIT_REF_NAME}"
    - docker push "${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}"

    - docker load < DOCKER_IMAGE_PREFIX/users.tar
    - docker tag DOCKER_IMAGE_PREFIX/users "${IMAGE_NAME}:${CI_COMMIT_REF_NAME}"
    - docker tag DOCKER_IMAGE_PREFIX/users "${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}"
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - docker push "${IMAGE_NAME}:${CI_COMMIT_REF_NAME}"
    - docker push "${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}"

    - docker load < DOCKER_IMAGE_PREFIX/orders.tar
    - docker tag DOCKER_IMAGE_PREFIX/orders "${IMAGE_NAME}:${CI_COMMIT_REF_NAME}"
    - docker tag DOCKER_IMAGE_PREFIX/orders "${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}"
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - docker push "${IMAGE_NAME}:${CI_COMMIT_REF_NAME}"
    - docker push "${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}"

deploy-dev:
  stage: Deploy dev
  script:
    - helm upgrade gateway gateway-chart --namespace $KUBE_NAMESPACE_DEV --values ./values.yaml
    - helm upgrade users users-chart --namespace $KUBE_NAMESPACE_DEV --values ./values.yaml
    - helm upgrade orders orders-chart --namespace $KUBE_NAMESPACE_DEV --values ./values.yaml

deploy-qa:
  stage: Deploy qa
  script:
    - helm upgrade gateway gateway-chart --namespace $KUBE_NAMESPACE_QA --values ./values.yaml
    - helm upgrade users users-chart --namespace $KUBE_NAMESPACE_QA --values ./values.yaml
    - helm upgrade orders orders-chart --namespace $KUBE_NAMESPACE_QA --values ./values.yaml

deploy-staging:
  stage: Deploy staging
  script:
    - helm upgrade gateway gateway-chart --namespace $KUBE_NAMESPACE_STAGING --values ./values.yaml
    - helm upgrade users users-chart --namespace $KUBE_NAMESPACE_STAGING --values ./values.yaml
    - helm upgrade orders orders-chart --namespace $KUBE_NAMESPACE_STAGING --values ./values.yaml

deploy-prod:
  stage: Deploy prod
  script:
    - helm upgrade gateway gateway-chart --namespace $KUBE_NAMESPACE_PROD --values ./values.yaml
    - helm upgrade users users-chart --namespace $KUBE_NAMESPACE_PROD --values ./values.yaml
    - helm upgrade orders orders-chart --namespace $KUBE_NAMESPACE_PROD --values ./values.yaml
  environment:
    name: $KUBE_NAMESPACE_PROD
  only:
    - main
  when: manual
